---
- name: üîê Gesti√≥n de Clave GPG para Ansible-Sign
  hosts: localhost # Generalmente esto se ejecuta en el host de control para firmar un proyecto.
  connection: local
  gather_facts: no
  vars_files:
    - vars/gpg_vars.yml
  vars:
    local_path: "/tmp/repository_clone"

  tasks:
    - block:
      - name: Clone repository
        ansible.builtin.import_role:
          name: clone_repository

      - name: ‚úÖ Verificar resultado de la firma
        ansible.builtin.command:
          # Usamos --gnupg-home y --fingerprint para asegurar que usemos la clave correcta
          cmd: "ls {{local_path}}"

      - name: üìÅ Asegurar que el directorio GPG_HOME exista
        ansible.builtin.file:
          path: "{{ gpg_home_dir }}"
          state: directory
          mode: '0700'

      - name: üìù Decodificar e Importar Clave Privada al EE
        ansible.builtin.copy:
          content: "{{ gpg_private_key_b64 | b64decode }}"
          dest: "/tmp/imported_private.asc"
          mode: '0600'

      - name: üì• Importar la clave GPG al GNUPGHOME
        ansible.builtin.command:
          # Importar la clave y usar la passphrase del archivo batch (stdin)
          cmd: "gpg --homedir {{ gpg_home_dir }} --batch --import /tmp/imported_private.asc"
          stdin: |
            {{ gpg_passphrase }}
        environment:
          GNUPGHOME: "{{ gpg_home_dir }}"

      - name: ‚úÖ Establecer Fingerprint est√°tico
        ansible.builtin.set_fact:
          gpg_fingerprint_value: "{{ gpg_signer_fingerprint }}"

      - name: üîé Verificar si MANIFEST.in existe
        ansible.builtin.stat:
          path: "/tmp/repository_clone/MANIFEST.in"
        register: manifest_stat

      - name: üìù Crear MANIFEST.in si no existe
        ansible.builtin.copy:
          content: |
            include *
            recursive-include . *
            global-exclude .git
            global-exclude .gitignore
            global-exclude .gitattributes
          dest: "{{ local_path }}/MANIFEST.in"
          mode: '0644'
        when: not manifest_stat.stat.exists

      - name: üßπ Limpiar firma anterior (Opcional)
        ansible.builtin.file:
          path: "{{ local_path }}/.ansible-sign"
          state: absent

      - name: üìÅ Crear directorio de firma .ansible-sign
        ansible.builtin.file:
          path: "{{ local_path }}/.ansible-sign"
          state: directory
          mode: '0755'

      - name: 1Ô∏è‚É£ Generar Checksums (replicando ansible-sign)
        # Este comando genera el sha256sum de todos los archivos del proyecto.
        # El comando 'find' obtiene la lista de archivos a firmar basada en MANIFEST.in
        ansible.builtin.shell:
          cmd: |
            cd {{ local_path }} && \
            find . -type f -print0 | xargs -0 sha256sum > .ansible-sign/sha256sum.txt
        
      - name: 2Ô∏è‚É£ Firmar el Checksums con GPG puro (sin TTY)
        # Firmar el archivo de checksums, inyectando la contrase√±a y bypassando pinentry
        ansible.builtin.command:
          cmd: "gpg --homedir {{ gpg_home_dir }} --batch --pinentry-mode loopback --passphrase-fd 0 --default-key {{ gpg_signer_fingerprint }} --output {{ local_path }}/.ansible-sign/sha256sum.txt.sig --detach-sig {{ local_path }}/.ansible-sign/sha256sum.txt"
          stdin: "{{ gpg_passphrase }}"
        environment:
          # Asegura que GPG use el home directory
          GNUPGHOME: "{{ gpg_home_dir }}"
        register: gpg_pure_sign_result
        
      - name: 3Ô∏è‚É£ Mostrar resultado de la firma GPG pura
        ansible.builtin.debug:
          msg: "Firma GPG pura completada: {{ gpg_pure_sign_result.stdout }}"

      - name: üîç Verificar la firma con GPG Puro
        ansible.builtin.command:
          # 1. Comando principal: gpg --verify [archivo_firma] [archivo_checksums]
          cmd: "gpg --homedir {{ gpg_home_dir }} --batch --verify {{ local_path }}/.ansible-sign/sha256sum.txt.sig {{ local_path }}/.ansible-sign/sha256sum.txt"
        environment:
          GNUPGHOME: "{{ gpg_home_dir }}"
        register: gpg_verify_result
        
      - name: üí¨ Mostrar resultado de la verificaci√≥n
        ansible.builtin.debug:
          msg: "Resultado de la verificaci√≥n: {{ gpg_verify_result.stdout }} {{ gpg_verify_result.stderr }}"

      - name: üõë Fallar si la verificaci√≥n NO fue exitosa
        # gpg --verify regresa RC 0 en √©xito. Si no es 0, algo fall√≥ (clave incorrecta, firma rota, etc.).
        ansible.builtin.fail:
          msg: "La verificaci√≥n GPG fall√≥: Revise los mensajes de gpg_verify_result."
        when: gpg_verify_result.rc != 0

      - name: Push repository
        ansible.builtin.import_role:
          name: push_repository
          
      rescue:

        - name: Send Vars OutPut
          ansible.builtin.set_stats:
            data: 
              sign_execution_failed: true
              sign_id_execution: "{{awx_job_id }}"

        - name: Errors Checks
          ansible.builtin.fail:
            msg:  
              - "{{ 'Fallo en el proceso de firmado del proyecto' }}"
              
      when: awx_webhook_payload.head_commit.message.startswith("[PROMOTE-TO-AWX]")
