---
- name: üîê Gesti√≥n de Clave GPG para Ansible-Sign
  hosts: localhost # Generalmente esto se ejecuta en el host de control para firmar un proyecto.
  connection: local
  gather_facts: no
  vars_files:
    - vars/gpg_vars.yml

  tasks:
    
    - name: 3.4 Clonar el repositorio base localmente
      ansible.builtin.git:
        # La URL de clonaci√≥n debe usar el nuevo PAT
        repo: "https://{{ newly_created_pat }}@{{ git_host }}/{{ grupo }}/{{ repo_base }}.git"
        dest: "{{ local_path }}"
        version: "{{ repo_base_branch }}"
        clone: yes
        update: yes
      when: repo_final_url is defined

    - name: üìÅ Asegurar que el directorio GPG_HOME exista
      ansible.builtin.file:
        path: "{{ gpg_home_dir }}"
        state: directory
        mode: '0700'

    - name: üìù Crear archivo de configuraci√≥n GPG batch
      ansible.builtin.copy:
        content: "{{ gpg_key_config }}"
        dest: /tmp/gpg_batch_config
        mode: '0600'

    - name: ‚ú® Generar la clave GPG de forma no interactiva
      ansible.builtin.command:
        cmd: "gpg --batch --full-generate-key /tmp/gpg_batch_config"
        creates: "{{ gpg_home_dir }}/pubring.kbx" # Evita que se ejecute si ya existe
      environment:
        # Define el directorio GPG_HOME para aislar la clave
        GNUPGHOME: "{{ gpg_home_dir }}"

    - name: üîé Obtener el Fingerprint de la clave
      ansible.builtin.shell:
        cmd: "gpg --list-secret-keys --with-colons --with-fingerprint {{ gpg_key_email }} | awk -F: '/fpr:/ {print $10}' | head -n 1"
      environment:
        GNUPGHOME: "{{ gpg_home_dir }}"
      register: gpg_fingerprint

    - name: üí¨ Mostrar Fingerprint de la clave (para verificaci√≥n)
      ansible.builtin.debug:
        msg: "Fingerprint de la clave GPG: {{ gpg_fingerprint.stdout }}"

    # --- Secci√≥n de Uso con ansible-sign ---

    - name: üìù Crear archivo de prueba para firmar
      ansible.builtin.copy:
        content: |
          Este es un archivo de prueba para firmar.
          Hora: {{ ansible_date_time.iso8601_micro }}
        dest: /tmp/test_file_to_sign.txt
        # Usamos el m√≥dulo copy para asegurar que el archivo exista en el host de control.

    - name: ‚úçÔ∏è Firmar el archivo de prueba con ansible-sign
      ansible.builtin.command:
        # Usamos --gnupg-home y --fingerprint para asegurar que usemos la clave correcta
        cmd: "ansible-sign sign --gnupg-home {{ gpg_home_dir }} --fingerprint {{ gpg_fingerprint.stdout }} --passphrase '{{ gpg_passphrase }}' /tmp/test_file_to_sign.txt"
      register: sign_result

    - name: ‚úÖ Verificar resultado de la firma
      ansible.builtin.debug:
        msg: "Resultado de ansible-sign: {{ sign_result.stdout }}"

    - name: 3.6 Inicializar nuevo repositorio Git, agregar contenido y commit
      ansible.builtin.command: "{{ item }}"
      args:
        chdir: "{{ local_path }}"
      loop:
        - git add .
        - git config --global user.email "{{git_user}}@example.com"
        - git config --global user.name "{{git_user}}"
        - git config http.sslVerify false
        - git commit -m 'Sign playbook'
        - git push