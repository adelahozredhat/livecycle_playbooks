---
- hosts: localhost
  gather_facts: false
  vars:
    local_path: "/tmp/repository_clone"

  tasks:

    - name: 3.4 Clonar el repositorio a testear
      ansible.builtin.git:
        # La URL de clonaci√≥n debe usar el nuevo PAT
        repo: "{{awx_webhook_payload.repository.clone_url| replace('https://','https://'+git_token+'@')}}"
        dest: "{{ local_path }}"
        version: "{{ awx_webhook_payload.ref }}"
        clone: yes
        update: yes

    - name: YamlLint
      ansible.builtin.shell: yamllint . --no-warnings
      args:
        chdir: "{{ local_path }}/"
      register: yamllint_result
      ignore_errors: true

    - name: AnsibleLint
      ansible.builtin.shell: ansible-lint --nocolor
      args:
        chdir: "{{ local_path }}/"
      register: ansiblelint_result
      ignore_errors: true

    - name: Get stats for the folder
      ansible.builtin.stat:
        path: "{{ local_path }}/molecule" # Replace with the actual path
      register: folder_status

    - name: Molecules Test
      ansible.builtin.shell: molecule test
      args:
        chdir: "{{ local_path }}/molecule"
      register: molecule_result
      when: folder_status.stat.exists
      ignore_errors: true


    - name: Errors checks
      ansible.builtin.fail:
        msg: 
          - "{{ 'Fallo en el YamlLint, por favor reviselo' if yamllint_result.failed is defined and yamllint_result.failed }}"
          - "{{ 'Fallo en el AnsibleLint, por favor reviselo' if ansiblelint_result.failed is defined and ansiblelint_result.failed }}"
          - "{{ 'Fallo en el Molecules Test, por favor reviselo' if molecule_result is defined and molecule_result.failed is defined and molecule_result.failed }}" 
      when: (yamllint_result.failed is defined and yamllint_result.failed) or (ansiblelint_result.failed is defined and ansiblelint_result.failed) or (molecule_result is defined and molecule_result.failed is defined and molecule_result.failed)

     # - name: Generate gpg-sign
    
    # - name: AnsibleSign
    #   ansible.builtin.expect:
    #     command: ansible-sign project gpg-sign . -p 
    #     responses:
    #       "GPG Key Passphrase:": "PRUEBA"
    #   args:
    #     chdir: template_ansible_playbook_develop/

    # - name: Git Push