---
- hosts: localhost
  gather_facts: false
  vars:
    local_path: "/tmp/repository_clone"

  tasks:

    - name: 3.4 Clonar el repositorio a testear
      ansible.builtin.git:
        # La URL de clonaciÃ³n debe usar el nuevo PAT
        repo: "{{awx_webhook_payload.repository.clone_url| replace('https://','https://'+git_token+'@')}}"
        dest: "{{ local_path }}"
        version: "{{ awx_webhook_payload.ref }}"
        clone: yes
        update: yes

    - name: YamlLint
      ansible.builtin.shell: 'yamllint . --no-warnings -d "{extends: default, rules: {line-length: {max: 120}}}"'
      args:
        chdir: "{{ local_path }}/"
      register: yamllint_result
      ignore_errors: true

    - name: AnsibleLint
      ansible.builtin.shell: ansible-lint --nocolor
      args:
        chdir: "{{ local_path }}/"
      register: ansiblelint_result
      ignore_errors: true

    - name: Get stats for the folder
      ansible.builtin.stat:
        path: "{{ local_path }}/molecule" # Replace with the actual path
      register: folder_status

    - name: Molecules Test
      ansible.builtin.shell: molecule test
      args:
        chdir: "{{ local_path }}"
      register: molecule_result
      when: folder_status.stat.exists
      ignore_errors: true


    - name: Errors checks
      ansible.builtin.fail:
        msg: 
          - "{{ 'Fallo en el YamlLint, por favor reviselo' if yamllint_result.failed is defined and yamllint_result.failed }}"
          - "{{ 'Fallo en el AnsibleLint, por favor reviselo' if ansiblelint_result.failed is defined and ansiblelint_result.failed }}"
          - "{{ 'Fallo en el Molecules Test, por favor reviselo' if molecule_result is defined and molecule_result.failed is defined and molecule_result.failed }}" 
      when: (yamllint_result.failed is defined and yamllint_result.failed) or (ansiblelint_result.failed is defined and ansiblelint_result.failed) or (molecule_result is defined and molecule_result.failed is defined and molecule_result.failed)

    - name: 4.1 ENVIAR NOTIFICACIÃ“N POR EMAIL (ansible.builtin.mail)
      ansible.builtin.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port|int }}"
        username: "{{ smtp_user }}"
        password: "{{ smtp_password }}"
        to: "{{ smtp_to }}"
        subject: "âœ… Repositorio Creado [{{ tipo_repositorio | upper }}]: {{ repo_nuevo }}"
        body: |
          Hola,

          Se ha completado la automatizaciÃ³n.
          - URL de Acceso: {{ repo_final_url }}
          - Webhook (https://{{ aap_hostname }}{{ aap_job_template_content_results[0].related.webhook_receiver }}) configurado.
          - PAT de usuario creado para este proceso.

          ðŸš¨ Â¡ADVERTENCIA DE SEGURIDAD! El nuevo PAT de usuario tiene alcance amplio y es visible 
          en los logs de la ejecuciÃ³n (variable 'newly_created_pat'). DeberÃ­a ser almacenado 
          inmediatamente en un gestor de secretos (Vault) y luego borrado de la plataforma si no es necesario.

          Saludos,
          Plataforma de AutomatizaciÃ³n AWX/AAP
      when: repo_final_url is defined and repo_final_url != "" and smtp_host is defined and "email" in canales_comunicacion

    - name: 4.2 ENVIAR NOTIFICACIÃ“N POR SLACK (community.general.slack)
      community.general.slack:
        token: "{{ slack_api_token }}"
        channel: "{{ slack_channel }}"
        msg: "ðŸš€ *Nuevo Repositorio Creado en {{ tipo_repositorio | upper }}*\n- *Nombre:* `{{ repo_nuevo }}`\n- *URL:* <{{ repo_final_url }}|Abrir Repositorio>\n- *PAT Creado:* Nuevo PAT de usuario generado para la automatizaciÃ³n.\n*(Recuperar el valor del PAT de los logs de AWX/AAP)*"
        username: "AWX Automation"
        icon_emoji: ":rocket:"
      when: repo_final_url is defined and repo_final_url != "" and slack_api_token is defined and "slack" in canales_comunicacion
